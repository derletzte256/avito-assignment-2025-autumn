# avito-assignment-2025-autumn

## Инструкция по запуску проекта

*По .env находятся стандартные настройки из требований, но это является плохой практикой*

Выполните команду
```bash
make up-default
```

Эта команда копирует .env.example в .env, собирает и запускает контейнеры Docker с настройками по умолчанию.

Если запуск со своим .env используйте команду
```bash
make up
```

Для удаления контейнеров и хранилищ выполните команду
```bash
make down
```

По умолчанию микросервис доступен по адресу: `http://localhost:8080`

## Дополнительные команды

**Примечание**: Все команды ниже перед выполнением требуют установки зависимостей `make setup`

1. Форматирование кода:
    ```bash
    make format
    ```

2. Запуск проверки линтером:
    ```bash
    make lint
    ```

3. Юнит-тесты:
   1. Генерация моков с помощью mockery (по умолчанию уже есть в репозитории, но хорошей практикой является их обновление перед тестированием):
       ```bash
        make mocks
       ```
   2. Запуск юнит-тестов:
      ```bash
      make unit
      ```
      
## E2E тесты:
Запуск E2E тестов:
```bash
make e2e
```
      
## Конфигурация линтера
Используемые линтеры:
- govet - линтер кода на ошибки, которые потенциально могут привести к багам (c опцией shadow, которая будет запрещать теневое объявление переменных)
- staticcheck - статический анализатор кода
- errcheck - проверка на не обработанные ошибки
- revive - линтер (используется `severity=warning`)
- ineffassign - проверка на неэффективные присвоения
- goconst - поиск повторяющихся строковых констант

Используемые форматировщики:
- goimports - проверяет правильность импортов
- gofmt - проверяет форматирование кода



## Дополнительные эндпоинты
1. `GET /users/getStatistics` - возвращает статистику для каждого пользователя. \
    *Выходные данные:*
    ```json
    {
     "users_stat": {
        "u1": {
            "user_id": "u1",
            "authored_pr_count": 1,
            "on_review_pr_count": 2,
            "reviewed_pr_count": 3
        },
        "u2": {
            "user_id": "u2",
            "authored_pr_count": 4,
            "on_review_pr_count": 5,
            "reviewed_pr_count": 6
        }
     }
   }
    ```
   - `authored_pr_count` - количество созданных пользователем PR
   - `on_review_pr_count` - количество PR, где пользователь является ревьювером и PR открыт
   - `reviewed_pr_count` - количество PR, где пользователь является ревьювером и PR закрыт

2. `POST /users/massDeactivate` - метод массовой деактивации пользователей команды с безопасным переназначением открытых PR. \
    *Входные данные:*
    ```json
    {
      "team_name": "team-1",
      "user_ids": [
        "u1"
      ]
    }
    ```
    - `team_name` - имя команды, в которой необходимо деактивировать пользователей
    - `user_ids` - список идентификаторов пользователей, которых необходимо деактивировать 
   
    *Выходные данные:*
    ```json
    {
      "team_name": "team-1",
      "review_reassignments": [
        {
          "pull_request_id": "pr1",
          "old_reviewer_id": "u1",
          "new_reviewer_id": "u2"
        }
      ],
      "unreassigned_reviews": [
        {
          "pull_request_id": "pr2",
          "reviewer_id": "u1"
        }
      ]
    }
    ```
   - `team_name` - имя команды, в которой были деактивированы пользователи
   - `review_reassignments` - список переназначенных ревью с указанием
     - `pull_request_id` - идентификатор PR
     - `old_reviewer_id` - идентификатор деактивированного пользователя
     - `new_reviewer_id` - идентификатор пользователя, которому был переназначен его PR
   - `unreassigned_reviews` - список ревью, которые не удалось переназначить с указанием (PR остается у деактивированного пользователя)
     - `pull_request_id` - идентификатор PR
     - `reviewer_id` - идентификатор деактивированного пользователя

## Допущения
1. *Как передавать ошибку о валидации?*
    - Так как в openapi.yml нет описания ошибок валидации и их кодов, введена ошибка с кодом INVALID_INPUT и данным о том, что юзер забыл или неправильно указан
2. *Какие ограничения задавать на входные данные?*
    - В openapi.yml нет ограничений на входные данные, поэтому были введены общие ограничения:
      - Для идентификатора максимальная длина 64 символа
      - Для текстовых полей - 128
3. *Что делать, если при создании команды передается пустой список пользователей?*
    - Данное поведение считается корректным, так как в будущем возможно процесс создания команды и назначения пользователей может быть разделен
4. *Что делать, если при создании команды часть пользователей с заданными идентификаторами существует, а часть нет?*
    - Так как в openapi.yml указано, что пользователи создаются/обновляются, то существующие пользователи меняют команду и юзернейм (если отличается), а несуществующие создаются
5. *Что делать с пользователями при массовой деактивации, если нет активных пользователей в команде нет активных кандидатов?*
    - В данном случае PR остается у деактивированного пользователя, а в ответе возвращается информация о том, что переназначение не произошло
    - Далее администратор зная эту информацию, может сделать переназначение позже, когда будут доступные кандидаты.
6. *Как выбирать кандидатов на переназначение при массовой деактивации?*
    - PR для переназначения распределяются случайным образом между всеми активными пользователями команды, кроме деактивируемых и кроме авторов PR
7. *Нужно ли в методе изменения статуса распределять PR, если ревьювер деактивируется?*
    - Нет, для этого есть метод массовой деактивации, а этот метод просто меняет статус ревьювьювера (скорее временно для блокировки доступа, в случае деактивации)
8. *Нужно ли заполнять базу данных данными?*
    - Так как в задании не указано, я решил добавить миграции для добавления сгенерированных данных. Если они мешают, последнюю миграцию можно удалить перед запуском.
9. *Как подгружать миграции?*
    - Так как требуются выполнить миграции при старте docker-compose, я заэмбеддил миграции в сам сервер, чтобы он подгружал новые миграции при старте.


       
     
   
   


